Û
DC:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Abstractions\ApiController.cs
	namespace 	
ITDeskServer
 
. 
Abstractions #
;# $
[ 
Route 
( 
$str "
)" #
]# $
[ 
ApiController 
] 
[ 
	Authorize 

(
 !
AuthenticationSchemes  
=! "
$str# +
)+ ,
], -
public 
abstract 
class 
ApiController #
:# $
ControllerBase% 3
{		 
}

 ä
FC:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Context\ApplicationDbContext.cs
	namespace 	
ITDeskServer
 
. 
Context 
; 
public 
sealed 
class  
ApplicationDbContext (
:) *
IdentityDbContext* ;
<; <
AppUser< C
,C D
AppRoleD K
,K L
GuidL P
>P Q
{		 
public

 
 
ApplicationDbContext

 
(

  
DbContextOptions

  0
options

1 8
)

8 9
:

: ;
base

< @
(

@ A
options

A H
)

H I
{ 
} 
public 

DbSet 
< 
Ticket 
> 
Tickets  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 

DbSet 
< 

TicketFile 
> 
TicketFiles (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
public 

DbSet 
< 
TicketDetail 
> 
TicketDetails ,
{- .
get/ 2
;2 3
set4 7
;7 8
}9 :
public 

DbSet 
< 
AppUserRole 
> 
AppUserRoles *
{+ ,
get- 0
;0 1
set2 5
;5 6
}7 8
	protected 
override 
void 
OnModelCreating +
(+ ,
ModelBuilder, 8
builder9 @
)@ A
{ 
builder 
. 
Entity 
< 
AppUserRole "
>" #
(# $
)$ %
.% &
HasKey& ,
(, -
x- .
=>. 0
new1 4
{5 6
x6 7
.7 8
RoleId8 >
,> ?
x@ A
.A B
UserIdB H
}H I
)I J
;J K
builder 
. 
Ignore 
< 
IdentityUserRole '
<' (
Guid( ,
>, -
>- .
(. /
)/ 0
;0 1
builder 
. 
Ignore 
< 
IdentityRoleClaim (
<( )
Guid) -
>- .
>. /
(/ 0
)0 1
;1 2
builder 
. 
Ignore 
< 
IdentityUserClaim (
<( )
Guid) -
>- .
>. /
(/ 0
)0 1
;1 2
builder 
. 
Ignore 
< 
IdentityUserLogin (
<( )
Guid) -
>- .
>. /
(/ 0
)0 1
;1 2
builder 
. 
Ignore 
< 
IdentityUserToken (
<( )
Guid) -
>- .
>. /
(/ 0
)0 1
;1 2
} 
} ÌQ
DC:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Controllers\AuthController.cs
	namespace 	
ITDeskServer
 
. 
Controllers "
;" #
[ 
AllowAnonymous 
] 
public 
class 
AuthController 
(  
ApplicationDbContext 
context  
,  !
UserManager 
< 
AppUser 
> 
userManager $
,$ %
SignInManager 
< 
AppUser 
> 
signInManager (
,( )

JwtService 

jwtService 
) 
: 
ApiController *
{ 
[ 
HttpPost 
] 
public 

async 
Task 
< 
IActionResult #
># $
Login% *
(* +
LoginDto+ 3
request4 ;
,; <
CancellationToken= N
cancellationTokenO `
)` a
{ 
LoginValidator 
	validator  
=! "
new# &
(& '
)' (
;( )
ValidationResult 
validationResult )
=* +
	validator, 5
.5 6
Validate6 >
(> ?
request? F
)F G
;G H
if 

( 
! 
validationResult 
. 
IsValid %
)% &
{ 	
return 

StatusCode 
( 
$num !
,! "
validationResult# 3
.3 4
Errors4 :
.: ;
Select; A
(A B
sB C
=>D F
sG H
.H I
ErrorMessageI U
)U V
)V W
;W X
} 	
AppUser!! 
?!! 
appUser!! 
=!! 
await!!  
userManager!!! ,
.!!, -
FindByNameAsync!!- <
(!!< =
request!!= D
.!!D E
UserNameOrEmail!!E T
)!!T U
;!!U V
if"" 

("" 
appUser"" 
is"" 
null"" 
)"" 
{## 	
appUser$$ 
=$$ 
await$$ 
userManager$$ '
.$$' (
FindByEmailAsync$$( 8
($$8 9
request$$9 @
.$$@ A
UserNameOrEmail$$A P
)$$P Q
;$$Q R
if%% 
(%% 
appUser%% 
is%% 
null%% 
)%%  
{&& 
return'' 

BadRequest'' !
(''! "
new''" %
{''& '
Message''( /
=''0 1
$str''2 I
}''J K
)''K L
;''L M
}(( 
})) 	
var++ 
result++ 
=++ 
await++ 
signInManager++ (
.++( )$
CheckPasswordSignInAsync++) A
(++A B
appUser++B I
,++I J
request++K R
.++R S
Password++S [
,++[ \
true++] a
)++a b
;++b c
if-- 

(-- 
result-- 
.-- 
IsLockedOut-- 
)-- 
{.. 	
TimeSpan// 
?// 
timeSpan// 
=//  
appUser//! (
.//( )

LockoutEnd//) 3
-//4 5
DateTime//6 >
.//> ?
UtcNow//? E
;//E F
if00 
(00 
timeSpan00 
is00 
not00 
null00  $
)00$ %
return11 

BadRequest11 !
(11! "
new11" %
{22 
Message33 
=33 
$"33  
$str33  R
{33R S
Math33S W
.33W X
Ceiling33X _
(33_ `
timeSpan33` h
.33h i
Value33i n
.33n o
TotalMinutes33o {
)33{ |
}33| }
$str	33} ë
"
33ë í
}44 
)44 
;44 
else55 
return66 

BadRequest66 !
(66! "
new66" %
{66& '
Message66( /
=660 1
$"662 4
$str664 |
"66| }
}66~ 
)	66 Ä
;
66Ä Å
}77 	
if99 

(99 
result99 
.99 
IsNotAllowed99 
)99  
{:: 	
return;; 

BadRequest;; 
(;; 
new;; !
{;;" #
Message;;$ +
=;;, -
$str;;. L
};;M N
);;N O
;;;O P
}<< 	
if>> 

(>> 
!>> 
result>> 
.>> 
	Succeeded>> 
)>> 
{?? 	
return@@ 

BadRequest@@ 
(@@ 
new@@ !
{@@" #
Message@@$ +
=@@, -
$str@@. ?
}@@@ A
)@@A B
;@@B C
}AA 	
varCC 
rolesCC 
=CC 
contextDD 
.DD 
AppUserRolesDD  
.EE 
WhereEE 
(EE 
pEE 
=>EE 
pEE 
.EE 
UserIdEE 
==EE  "
appUserEE# *
.EE* +
IdEE+ -
)EE- .
.FF 
IncludeFF 
(FF 
pFF 
=>FF 
pFF 
.FF 
RoleFF 
)FF  
.GG 
SelectGG 
(GG 
sGG 
=>GG 
sGG 
.GG 
RoleGG 
!GG 
.GG  
NameGG  $
)GG$ %
.HH 
ToListHH 
(HH 
)HH 
;HH 
stringJJ 
tokenJJ 
=JJ 

jwtServiceJJ !
.JJ! "
CreateTokenJJ" -
(JJ- .
appUserJJ. 5
,JJ5 6
rolesJJ7 <
,JJ< =
requestJJ> E
.JJE F

RememberMeJJF P
)JJP Q
;JJQ R
returnKK 
OkKK 
(KK 
newKK 
{KK 
AccessTokenKK #
=KK$ %
tokenKK& +
}KK, -
)KK- .
;KK. /
}LL 
[NN 
HttpPostNN 
]NN 
publicOO 

asyncOO 
TaskOO 
<OO 
IActionResultOO #
>OO# $
GoogleLoginOO% 0
(OO0 1
GoogleLoginDtoOO1 ?
requestOO@ G
,OOG H
CancellationTokenOOI Z
cancellationTokenOO[ l
)OOl m
{PP 
AppUserQQ 
?QQ 
appUserQQ 
=QQ 
awaitQQ  
userManagerQQ! ,
.QQ, -
FindByEmailAsyncQQ- =
(QQ= >
requestQQ> E
.QQE F
EmailQQF K
)QQK L
;QQL M
ifRR 

(RR 
appUserRR 
isRR 
notRR 
nullRR 
)RR  
{SS 	
varTT 
rolesTT 
=TT 
contextUU 
.UU 
AppUserRolesUU  
.VV 
WhereVV 
(VV 
pVV 
=>VV 
pVV 
.VV 
UserIdVV  
==VV! #
appUserVV$ +
.VV+ ,
IdVV, .
)VV. /
.WW 
IncludeWW 
(WW 
pWW 
=>WW 
pWW 
.WW 
RoleWW  
)WW  !
.XX 
SelectXX 
(XX 
sXX 
=>XX 
sXX 
.XX 
RoleXX 
!XX  
.XX  !
NameXX! %
)XX% &
.YY 
ToListYY 
(YY 
)YY 
;YY 
string[[ 
token[[ 
=[[ 

jwtService[[ %
.[[% &
CreateToken[[& 1
([[1 2
appUser[[2 9
,[[9 :
roles[[; @
,[[@ A
true[[B F
)[[F G
;[[G H
return\\ 
Ok\\ 
(\\ 
new\\ 
{\\ 
AccessToken\\ '
=\\( )
token\\* /
}\\0 1
)\\1 2
;\\2 3
}]] 	
string__ 
userName__ 
=__ 
request__ !
.__! "
Email__" '
;__' (
appUseraa 
=aa 
newaa 
(aa 
)aa 
{bb 	
Emailcc 
=cc 
requestcc 
.cc 
Emailcc !
,cc! "
	FirstNamedd 
=dd 
requestdd 
.dd  
	FirstNamedd  )
,dd) *
LastNameee 
=ee 
requestee 
.ee 
LastNameee '
,ee' (
UserNameff 
=ff 
userNameff 
,ff  
GoogleProvideIdgg 
=gg 
requestgg %
.gg% &
Idgg& (
}hh 	
;hh	 

IdentityResultjj 
resultjj 
=jj 
awaitjj  %
userManagerjj& 1
.jj1 2
CreateAsyncjj2 =
(jj= >
appUserjj> E
)jjE F
;jjF G
ifll 

(ll 
resultll 
.ll 
	Succeededll 
)ll 
{mm 	
stringnn 
tokennn 
=nn 

jwtServicenn %
.nn% &
CreateTokennn& 1
(nn1 2
appUsernn2 9
,nn9 :
newnn; >
(nn> ?
)nn? @
,nn@ A
truennB F
)nnF G
;nnG H
returnoo 
Okoo 
(oo 
newoo 
{oo 
AccessTokenoo '
=oo( )
tokenoo* /
}oo0 1
)oo1 2
;oo2 3
}pp 	
IdentityErrorrr 
?rr 
errorResultrr "
=rr# $
resultrr% +
.rr+ ,
Errorsrr, 2
.rr2 3
FirstOrDefaultrr3 A
(rrA B
)rrB C
;rrC D
stringtt 
errorMessagett 
=tt 
errorResultuu 
isuu 
nulluu 
?uu  !
$strvv R
:vvS T
errorResultww 
.ww 
Descriptionww #
;ww# $
returnyy 

BadRequestyy 
(yy 
newyy 
{yy 
Messageyy  '
=yy( )
errorMessageyy* 6
}yy7 8
)yy8 9
;yy9 :
}zz 
}{{ —x
GC:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Controllers\TicketsController.cs
	namespace

 	
ITDeskServer


 
.

 
Controllers

 "
;

" #
public 
class 
TicketsController 
:  
ApiController! .
{ 
private 
readonly  
ApplicationDbContext )
_context* 2
;2 3
public 

TicketsController 
(  
ApplicationDbContext 1
context2 9
)9 :
{ 
_context 
= 
context 
; 
} 
[ 
HttpPost 
] 
public 

IActionResult 
Add 
( 
[ 
FromForm &
]& '
TicketAddDto( 4
request5 <
)< =
{ 
string 
? 
userId 
= 
HttpContext $
.$ %
User% )
.) *
Claims* 0
.0 1
Where1 6
(6 7
p7 8
=>8 :
p; <
.< =
Type= A
==B D
$strE M
)M N
.N O
SelectO U
(U V
sV W
=>W Y
sZ [
.[ \
Value\ a
)a b
.b c
FirstOrDefaultc q
(q r
)r s
;s t
if 

(
 
userId 
is 
null 
) 
{ 	
return 

BadRequest 
( 
new !
{" #
Message$ +
=, -
$str. D
}E F
)F G
;G H
} 	
AppUser 
? 
appUser 
= 
_context #
.# $
Users$ )
.) *
Where* /
(/ 0
p0 1
=>2 4
p5 6
.6 7
Id7 9
==: <
Guid= A
.A B
ParseB G
(G H
userIdH N
)N O
)O P
.P Q
FirstOrDefaultQ _
(_ `
)` a
;a b
if!! 

(!!
 
appUser!! 
is!! 
null!! 
)!! 
{"" 	
return## 

BadRequest## 
(## 
new## !
{##" #
Message##$ +
=##, -
$str##. D
}##E F
)##F G
;##G H
}$$ 	
Ticket&& 
ticket&& 
=&& 
new&& 
(&& 
)&& 
{'' 	
Id(( 
=(( 
Guid(( 
.(( 
NewGuid(( 
((( 
)(( 
,((  
CreatedDate)) 
=)) 
DateTime)) "
.))" #
Now))# &
,))& '
	AppUserId** 
=** 
Guid** 
.** 
Parse** "
(**" #
userId**# )
)**) *
,*** +
IsOpen++ 
=++ 
true++ 
,++ 
Subject,, 
=,, 
request,, 
.,, 
Subject,, %
,,,% &
}-- 	
;--	 

if// 

(//
 
request// 
.// 
Files// 
is// 
not// 
null//  $
)//$ %
{00 	
ticket11 
.11 
FileUrls11 
=11 
new11 !
(11! "
)11" #
;11# $
foreach33 
(33 
var33 
file33 
in33  
request33! (
.33( )
Files33) .
)33. /
{44 
string55 

fileFormat55 !
=55" #
file55$ (
.55( )
FileName55) 1
.551 2
	Substring552 ;
(55; <
file55< @
.55@ A
FileName55A I
.55I J
LastIndexOf55J U
(55U V
$char55V Y
)55Y Z
)55Z [
;55[ \
string66 
fileName66 
=66  !
Guid66" &
.66& '
NewGuid66' .
(66. /
)66/ 0
.660 1
ToString661 9
(669 :
)66: ;
+66< =

fileFormat66> H
;66H I
using77 
(77 
var77 
stream77 !
=77" #
System77$ *
.77* +
IO77+ -
.77- .
File77. 2
.772 3
Create773 9
(779 :
$str77: u
+77v w
fileName	77x Ä
)
77Ä Å
)
77Å Ç
{88 
file99 
.99 
CopyTo99 
(99  
stream99  &
)99& '
;99' (
}:: 

TicketFile<< 

ticketFile<< %
=<<& '
new<<( +
(<<+ ,
)<<, -
{== 
Id>> 
=>> 
Guid>> 
.>> 
NewGuid>> %
(>>% &
)>>& '
,>>' (
TicketId?? 
=?? 
ticket?? %
.??% &
Id??& (
,??( )
FileUrl@@ 
=@@ 
fileName@@ &
}AA 
;AA 
ticketCC 
.CC 
FileUrlsCC 
.CC  
AddCC  #
(CC# $

ticketFileCC$ .
)CC. /
;CC/ 0
}DD 
}EE 	
TicketDetailGG 
ticketDetailGG !
=GG" #
newGG$ '
(GG' (
)GG( )
{HH 	
IdII 
=II 
GuidII 
.II 
NewGuidII 
(II 
)II 
,II  
	AppUserIdJJ 
=JJ 
GuidJJ 
.JJ 
ParseJJ "
(JJ" #
userIdJJ# )
)JJ) *
,JJ* +
TicketIdKK 
=KK 
ticketKK 
.KK 
IdKK  
,KK  !
ContentLL 
=LL 
requestLL 
.LL 
SummaryLL %
,LL% &
CreatedDateMM 
=MM 
ticketMM  
.MM  !
CreatedDateMM! ,
}NN 	
;NN	 

_contextPP 
.PP 
TicketsPP 
.PP 
AddPP 
(PP 
ticketPP #
)PP# $
;PP$ %
_contextQQ 
.QQ 
TicketDetailsQQ 
.QQ 
AddQQ "
(QQ" #
ticketDetailQQ# /
)QQ/ 0
;QQ0 1
_contextRR 
.RR 
SaveChangesRR 
(RR 
)RR 
;RR 
returnUU 
	NoContentUU 
(UU 
)UU 
;UU 
}VV 
[XX 
HttpGetXX 
(XX 
$strXX 
)XX 
]XX 
publicYY 

IActionResultYY 

GetDetailsYY #
(YY# $
GuidYY$ (
ticketIdYY) 1
)YY1 2
{ZZ 
var[[ 
details[[ 
=[[ 
_context\\ 
.\\ 
TicketDetails\\ "
.]] 
Where]] 
(]] 
p]] 
=>]] 
p]] 
.]] 
TicketId]] !
==]]" $
ticketId]]% -
)]]- .
.^^ 
Include^^ 
(^^ 
p^^ 
=>^^ 
p^^ 
.^^ 
AppUser^^ "
)^^" #
.__ 
OrderBy__ 
(__ 
p__ 
=>__ 
p__ 
.__ 
CreatedDate__ &
)__& '
.__' (
ToList__( .
(__. /
)__/ 0
;__0 1
return`` 
Ok`` 
(`` 
details`` 
)`` 
;`` 
}aa 
[cc 
HttpGetcc 
]cc 
publicdd 

IActionResultdd 
GetByIddd  
(dd  !
Guiddd! %
ticketIddd& .
)dd. /
{ee 
varff 
detailsff 
=ff 
_contextgg 
.gg 
Ticketsgg 
.hh 
Wherehh 
(hh 
phh 
=>hh 
phh 
.hh 
Idhh 
==hh 
ticketIdhh  (
)hh( )
.ii 
Includeii 
(ii 
pii 
=>ii 
pii 
.ii 
AppUserii #
)ii# $
.jj 
Includejj 
(jj 
pjj 
=>jj 
pjj 
.jj 
FileUrlsjj #
)jj# $
.kk 
FirstOrDefaultkk 
(kk 
)kk 
;kk 
returnll 
Okll 
(ll 
detailsll 
)ll 
;ll 
}mm 
[oo 
HttpPostoo 
]oo 
publicpp 

IActionResultpp 
AddDetailContentpp )
(pp) *
TicketDetailDtopp* 9
requestpp: A
)ppA B
{qq 
Ticketrr 
?rr 
ticketrr 
=rr 
_contextss 
.ss 
Ticketsss 
.tt 
Wherett 
(tt 
ptt 
=>tt 
ptt 
.tt 
Idtt  
==tt! #
requesttt$ +
.tt+ ,
TicketIdtt, 4
)tt4 5
.uu 
FirstOrDefaultuu 
(uu  
)uu  !
;uu! "
ifww 

(ww
 
ticketww 
isww 
notww 
nullww 
)ww 
{xx 	
ticketyy 
.yy 
IsOpenyy 
=yy 
trueyy  
;yy  !
}zz 	
TicketDetail}} 
ticketDetail}} !
=}}" #
new}}$ '
(}}' (
)}}( )
{~~ 	
	AppUserId 
= 
request 
.  
	AppUserId  )
,) *
Content
ÄÄ 
=
ÄÄ 
request
ÄÄ 
.
ÄÄ 
Content
ÄÄ %
,
ÄÄ% &
CreatedDate
ÅÅ 
=
ÅÅ 
DateTime
ÅÅ "
.
ÅÅ" #
Now
ÅÅ# &
,
ÅÅ& '
TicketId
ÇÇ 
=
ÇÇ 
request
ÇÇ 
.
ÇÇ 
TicketId
ÇÇ '
}
ÉÉ 	
;
ÉÉ	 

_context
ÖÖ 
.
ÖÖ 
Add
ÖÖ 
(
ÖÖ 
ticketDetail
ÖÖ !
)
ÖÖ! "
;
ÖÖ" #
_context
ÜÜ 
.
ÜÜ 
SaveChanges
ÜÜ 
(
ÜÜ 
)
ÜÜ 
;
ÜÜ 
return
àà 
	NoContent
àà 
(
àà 
)
àà 
;
àà 
}
ââ 
[
ãã 
HttpPost
ãã 
]
ãã 
public
åå 

IActionResult
åå 
GetAll
åå 
(
åå  
GetAllTicketDto
åå  /
request
åå0 7
)
åå7 8
{
çç 
string
éé 
?
éé 
userId
éé 
=
éé 
HttpContext
éé $
.
éé$ %
User
éé% )
.
éé) *
Claims
éé* 0
.
éé0 1
Where
éé1 6
(
éé6 7
p
éé7 8
=>
éé9 ;
p
éé< =
.
éé= >
Type
éé> B
==
ééC E
$str
ééF N
)
ééN O
.
ééO P
Select
ééP V
(
ééV W
s
ééW X
=>
ééY [
s
éé\ ]
.
éé] ^
Value
éé^ c
)
ééc d
.
ééd e
FirstOrDefault
éée s
(
éés t
)
éét u
;
ééu v
if
èè 

(
èè 
userId
èè 
is
èè 
null
èè 
)
èè 
{
êê 	
return
ëë 

BadRequest
ëë 
(
ëë 
new
ëë !
{
ëë" #
Message
ëë$ +
=
ëë, -
$str
ëë. D
}
ëëE F
)
ëëF G
;
ëëG H
}
íí 	

IQueryable
îî 
<
îî 
TicketResponseDto
îî $
>
îî$ %
tickets
îî& -
=
îî. /
_context
ïï 
.
ïï 
Tickets
ïï 
.
ññ 
Include
ññ 
(
ññ 
p
ññ 
=>
ññ 
p
ññ 
.
ññ 
AppUser
ññ "
)
ññ" #
.
óó 
Select
óó 
(
óó 
s
óó 
=>
óó 
new
óó 
TicketResponseDto
óó .
{
òò 
Id
ôô 
=
ôô 
s
ôô 
.
ôô 
Id
ôô 
,
ôô 
	AppUserId
öö 
=
öö 
s
öö 
.
öö 
	AppUserId
öö '
,
öö' (
AppUser
õõ 
=
õõ 
s
õõ 
.
õõ 
AppUser
õõ #
,
õõ# $
UserName
úú 
=
úú 
s
úú 
.
úú 
AppUser
úú $
!
úú$ %
.
úú% &
GetName
úú& -
(
úú- .
)
úú. /
,
úú/ 0
CreatedDate
ùù 
=
ùù 
s
ùù 
.
ùù  
CreatedDate
ùù  +
.
ùù+ ,
ToString
ùù, 4
(
ùù4 5
$str
ùù5 8
)
ùù8 9
,
ùù9 :
IsOpen
ûû 
=
ûû 
s
ûû 
.
ûû 
IsOpen
ûû !
,
ûû! "
Subject
üü 
=
üü 
s
üü 
.
üü 
Subject
üü #
}
†† 
)
†† 
.
°° 
AsQueryable
°° 
(
°° 
)
°° 
;
°° 
if
££ 

(
££ 
!
££ 
request
££ 
.
££ 
Roles
££ 
.
££ 
Contains
££ #
(
££# $
$str
££$ +
)
££+ ,
)
££, -
{
§§ 	
tickets
•• 
=
•• 
tickets
•• 
.
•• 
Where
•• #
(
••# $
p
••$ %
=>
••& (
p
••) *
.
••* +
	AppUserId
••+ 4
==
••5 7
Guid
••8 <
.
••< =
Parse
••= B
(
••B C
userId
••C I
)
••I J
)
••J K
;
••K L
}
¶¶ 	
return
®® 
Ok
®® 
(
®® 
tickets
®® 
.
®® 
ToList
®®  
(
®®  !
)
®®! "
)
®®" #
;
®®# $
}
©© 
[
´´ 
HttpGet
´´ 
]
´´ 
public
¨¨ 

IActionResult
¨¨ #
CloseTicketByTicketId
¨¨ .
(
¨¨. /
Guid
¨¨/ 3
ticketId
¨¨4 <
)
¨¨< =
{
≠≠ 
Ticket
ÆÆ 
?
ÆÆ 
ticket
ÆÆ 
=
ÆÆ 
_context
ÆÆ !
.
ÆÆ! "
Tickets
ÆÆ" )
.
ÆÆ) *
Find
ÆÆ* .
(
ÆÆ. /
ticketId
ÆÆ/ 7
)
ÆÆ7 8
;
ÆÆ8 9
if
ØØ 

(
ØØ
 
ticket
ØØ 
is
ØØ 
not
ØØ 
null
ØØ 
)
ØØ 
{
∞∞ 	
ticket
±± 
.
±± 
IsOpen
±± 
=
±± 
false
±± !
;
±±! "
_context
≤≤ 
.
≤≤ 
SaveChanges
≤≤  
(
≤≤  !
)
≤≤! "
;
≤≤" #
}
≥≥ 	
return
µµ 
	NoContent
µµ 
(
µµ 
)
µµ 
;
µµ 
}
∂∂ 
}∑∑ Æ
FC:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Controllers\ValuesController.cs
	namespace 	
ITDeskServer
 
. 
Controllers "
;" #
public 
sealed 
class 
ValuesController $
:% &
ApiController' 4
{		 
[

 
HttpGet

 
]

 
public 

IActionResult 
Get 
( 
) 
{ 
return 
Ok 
( 
new 
{ 
Message 
=  !
$str" 2
}3 4
)4 5
;5 6
} 
}  
>C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\DTOs\GetAllTicketDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
sealed 
record 
GetAllTicketDto $
($ %
string% +
Roles, 1
)1 2
;2 3≈	
=C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\DTOs\GoogleLoginDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
sealed 
class 
GoogleLoginDto "
{ 
public 

string 
Id 
{ 
get 
; 
set 
;  
}! "
=# $
string% +
.+ ,
Empty, 1
;1 2
public 

string 
Email 
{ 
get 
; 
set "
;" #
}$ %
=& '
string( .
.. /
Empty/ 4
;4 5
public 

string 
	FirstName 
{ 
get !
;! "
set# &
;& '
}( )
=* +
string, 2
.2 3
Empty3 8
;8 9
public 

string 
LastName 
{ 
get  
;  !
set" %
;% &
}' (
=) *
string+ 1
.1 2
Empty2 7
;7 8
}		 ⁄
7C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\DTOs\LoginDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
sealed 
record 
LoginDto 
( 
string 

UserNameOrEmail 
, 
string 

Password 
, 
bool 

RememberMe	 
= 
false 
) 
; ˆ
;C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\DTOs\TicketAddDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
sealed 
record 
TicketAddDto !
(! "
string 

Subject 
, 
string 

Summary 
, 
List 
< 	
	IFormFile	 
> 
? 
Files 
) 
; ü
>C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\DTOs\TicketDetailDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
class 
TicketDetailDto 
{ 
public 

Guid 
TicketId 
{ 
get 
; 
set  #
;# $
}% &
public 

string 
Content 
{ 
get 
;  
set! $
;$ %
}& '
=( )
string* 0
.0 1
Empty1 6
;6 7
public 

Guid 
	AppUserId 
{ 
get 
; 
set  #
;# $
}$ %
} ì
@C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\DTOs\TicketResponseDto.cs
	namespace 	
ITDeskServer
 
. 
DTOs 
; 
public 
sealed 
record 
TicketResponseDto &
{ 
public 

Guid 
Id 
{ 
get 
; 
set 
; 
}  
public 

Guid 
	AppUserId 
{ 
get 
;  
set! $
;$ %
}& '
public		 

string		 
?		 
UserName		 
{		 
get		 !
;		! "
set		# &
;		& '
}		( )
public

 

AppUser

 
?

 
AppUser

 
{

 
get

 !
;

! "
set

# &
;

& '
}

( )
public 

string 
Subject 
{ 
get 
;  
set! $
;$ %
}& '
=( )
string* 0
.0 1
Empty1 6
;6 7
public 

string 
CreatedDate 
{ 
get  #
;# $
set% (
;( )
}* +
=, -
string. 4
.4 5
Empty5 :
;: ;
public 

bool 
IsOpen 
{ 
get 
; 
set !
;! "
}# $
} §<
IC:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Middleware\ExtensionsMiddleware.cs
	namespace 	
ITDeskServer
 
. 

Middleware !
;! "
public		 
static		 
class		  
ExtensionsMiddleware		 (
{

 
public 

static 
void 
AutoMigration $
($ %
WebApplication% 3
app4 7
)7 8
{ 
using 
( 
var 
scoped 
= 
app 
.  
Services  (
.( )
CreateScope) 4
(4 5
)5 6
)6 7
{ 	
var 
context 
= 
scoped  
.  !
ServiceProvider! 0
.0 1
GetRequiredService1 C
<C D 
ApplicationDbContextD X
>X Y
(Y Z
)Z [
;[ \
context 
. 
Database 
. 
Migrate $
($ %
)% &
;& '
} 	
} 
public 

static 
void 
CreateFirstUser &
(& '
WebApplication' 5
app6 9
)9 :
{ 
using 
( 
var 
scoped 
= 
app 
.  
Services  (
.( )
CreateScope) 4
(4 5
)5 6
)6 7
{ 	
var 
userManager 
= 
scoped $
.$ %
ServiceProvider% 4
.4 5
GetRequiredService5 G
<G H
UserManagerH S
<S T
AppUserT [
>[ \
>\ ]
(] ^
)^ _
;_ `
if 
( 
! 
userManager 
. 
Users "
." #
Any# &
(& '
)' (
)( )
{ 
userManager 
. 
CreateAsync '
(' (
new( +
(+ ,
), -
{ 
Email 
= 
$str +
,+ ,
UserName 
= 
$str %
,% &
	FirstName 
= 
$str  $
,$ %
LastName   
=   
$str   &
,  & '
EmailConfirmed!! "
=!!# $
true!!% )
}"" 
,"" 
$str""  
)""  !
.""! "
Wait""" &
(""& '
)""' (
;""( )
}## 
}$$ 	
}%% 
public'' 

static'' 
void'' 
CreateRoles'' "
(''" #
WebApplication''# 1
app''2 5
)''5 6
{(( 
using)) 
()) 
var)) 
scoped)) 
=)) 
app)) 
.))  
Services))  (
.))( )
CreateScope))) 4
())4 5
)))5 6
)))6 7
{** 	
var++ 
roleManager++ 
=++ 
scoped++ $
.++$ %
ServiceProvider++% 4
.++4 5
GetRequiredService++5 G
<++G H
RoleManager++H S
<++S T
AppRole++T [
>++[ \
>++\ ]
(++] ^
)++^ _
;++_ `
if,, 
(,, 
!,, 
roleManager,, 
.,, 
Roles,, "
.,," #
Any,,# &
(,,& '
),,' (
),,( )
{-- 
roleManager.. 
... 
CreateAsync.. '
(..' (
new..( +
AppRole.., 3
(..3 4
)..4 5
{// 
Id00 
=00 
Guid00 
.00 
NewGuid00 %
(00% &
)00& '
,00' (
Name11 
=11 
$str11 "
,11" #
}22 
)22 
.22 
Wait22 
(22 
)22 
;22 
}33 
}44 	
}55 
public77 

static77 
void77 
CreateUserRole77 %
(77% &
WebApplication77& 4
app775 8
)778 9
{88 
using99 
(99 
var99 
scoped99 
=99 
app99 
.99  
Services99  (
.99( )
CreateScope99) 4
(994 5
)995 6
)996 7
{:: 	
var;; 
context;; 
=;; 
scoped;;  
.;;  !
ServiceProvider;;! 0
.;;0 1
GetRequiredService;;1 C
<;;C D 
ApplicationDbContext;;D X
>;;X Y
(;;Y Z
);;Z [
;;;[ \
var<< 
userManager<< 
=<< 
scoped<< $
.<<$ %
ServiceProvider<<% 4
.<<4 5
GetRequiredService<<5 G
<<<G H
UserManager<<H S
<<<S T
AppUser<<T [
><<[ \
><<\ ]
(<<] ^
)<<^ _
;<<_ `
var== 
roleManager== 
=== 
scoped== $
.==$ %
ServiceProvider==% 4
.==4 5
GetRequiredService==5 G
<==G H
RoleManager==H S
<==S T
AppRole==T [
>==[ \
>==\ ]
(==] ^
)==^ _
;==_ `
AppUser?? 
??? 
user?? 
=?? 
userManager?? '
.??' (
Users??( -
.??- .
FirstOrDefault??. <
(??< =
p??= >
=>??? A
p??B C
.??C D
Email??D I
==??J L
$str??M \
)??\ ]
;??] ^
if@@ 
(@@ 
user@@ 
is@@ 
not@@ 
null@@ 
)@@  
{AA 
AppRoleBB 
?BB 
roleBB 
=BB 
roleManagerBB  +
.BB+ ,
RolesBB, 1
.BB1 2
FirstOrDefaultBB2 @
(BB@ A
pBBA B
=>BBC E
pBBF G
.BBG H
NameBBH L
==BBM O
$strBBP W
)BBW X
;BBX Y
ifCC 
(CC 
roleCC 
isCC 
notCC 
nullCC #
)CC# $
{DD 
boolEE 
userRoleExistEE &
=EE' (
contextEE) 0
.EE0 1
AppUserRolesEE1 =
.EE= >
AnyEE> A
(EEA B
pEEB C
=>EEC E
pEEF G
.EEG H
RoleIdEEH N
==EEO Q
roleEER V
.EEV W
IdEEW Y
&&EEZ \
pEE] ^
.EE^ _
UserIdEE_ e
==EEf h
userEEi m
.EEm n
IdEEn p
)EEp q
;EEq r
ifFF 
(FF 
!FF 
userRoleExistFF &
)FF& '
{GG 
AppUserRoleHH #
appUserRoleHH$ /
=HH0 1
newHH2 5
(HH5 6
)HH6 7
{II 
RoleIdJJ "
=JJ# $
roleJJ% )
.JJ) *
IdJJ* ,
,JJ, -
UserIdKK "
=KK# $
userKK% )
.KK) *
IdKK* ,
,KK, -
}LL 
;LL 
contextNN 
.NN  
AppUserRolesNN  ,
.NN, -
AddNN- 0
(NN0 1
appUserRoleNN1 <
)NN< =
;NN= >
contextOO 
.OO  
SaveChangesOO  +
(OO+ ,
)OO, -
;OO- .
}PP 
}QQ 
}RR 
}SS 	
}TT 
}UU πã
GC:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Migrations\20231213193615_mg1.cs
	namespace 	
ITDeskServer
 
. 

Migrations !
{ 
public		 

partial		 
class		 
mg1		 
:		 
	Migration		 (
{

 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str 
, 
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
Guid& *
>* +
(+ ,
type, 0
:0 1
$str2 D
,D E
nullableF N
:N O
falseP U
)U V
,V W
Name 
= 
table  
.  !
Column! '
<' (
string( .
>. /
(/ 0
type0 4
:4 5
$str6 E
,E F
nullableG O
:O P
trueQ U
)U V
,V W
NormalizedName "
=# $
table% *
.* +
Column+ 1
<1 2
string2 8
>8 9
(9 :
type: >
:> ?
$str@ O
,O P
nullableQ Y
:Y Z
true[ _
)_ `
,` a
ConcurrencyStamp $
=% &
table' ,
., -
Column- 3
<3 4
string4 :
>: ;
(; <
type< @
:@ A
$strB Q
,Q R
nullableS [
:[ \
true] a
)a b
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% /
,/ 0
x1 2
=>3 5
x6 7
.7 8
Id8 :
): ;
;; <
} 
) 
; 
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str 
, 
columns 
: 
table 
=> !
new" %
{ 
Id   
=   
table   
.   
Column   %
<  % &
Guid  & *
>  * +
(  + ,
type  , 0
:  0 1
$str  2 D
,  D E
nullable  F N
:  N O
false  P U
)  U V
,  V W
	FirstName!! 
=!! 
table!!  %
.!!% &
Column!!& ,
<!!, -
string!!- 3
>!!3 4
(!!4 5
type!!5 9
:!!9 :
$str!!; J
,!!J K
nullable!!L T
:!!T U
false!!V [
)!![ \
,!!\ ]
LastName"" 
="" 
table"" $
.""$ %
Column""% +
<""+ ,
string"", 2
>""2 3
(""3 4
type""4 8
:""8 9
$str"": I
,""I J
nullable""K S
:""S T
false""U Z
)""Z [
,""[ \
GoogleProvideId## #
=##$ %
table##& +
.##+ ,
Column##, 2
<##2 3
string##3 9
>##9 :
(##: ;
type##; ?
:##? @
$str##A P
,##P Q
nullable##R Z
:##Z [
true##\ `
)##` a
,##a b
UserName$$ 
=$$ 
table$$ $
.$$$ %
Column$$% +
<$$+ ,
string$$, 2
>$$2 3
($$3 4
type$$4 8
:$$8 9
$str$$: I
,$$I J
nullable$$K S
:$$S T
true$$U Y
)$$Y Z
,$$Z [
NormalizedUserName%% &
=%%' (
table%%) .
.%%. /
Column%%/ 5
<%%5 6
string%%6 <
>%%< =
(%%= >
type%%> B
:%%B C
$str%%D S
,%%S T
nullable%%U ]
:%%] ^
true%%_ c
)%%c d
,%%d e
Email&& 
=&& 
table&& !
.&&! "
Column&&" (
<&&( )
string&&) /
>&&/ 0
(&&0 1
type&&1 5
:&&5 6
$str&&7 F
,&&F G
nullable&&H P
:&&P Q
true&&R V
)&&V W
,&&W X
NormalizedEmail'' #
=''$ %
table''& +
.''+ ,
Column'', 2
<''2 3
string''3 9
>''9 :
('': ;
type''; ?
:''? @
$str''A P
,''P Q
nullable''R Z
:''Z [
true''\ `
)''` a
,''a b
EmailConfirmed(( "
=((# $
table((% *
.((* +
Column((+ 1
<((1 2
bool((2 6
>((6 7
(((7 8
type((8 <
:((< =
$str((> C
,((C D
nullable((E M
:((M N
false((O T
)((T U
,((U V
PasswordHash))  
=))! "
table))# (
.))( )
Column))) /
<))/ 0
string))0 6
>))6 7
())7 8
type))8 <
:))< =
$str))> M
,))M N
nullable))O W
:))W X
true))Y ]
)))] ^
,))^ _
SecurityStamp** !
=**" #
table**$ )
.**) *
Column*** 0
<**0 1
string**1 7
>**7 8
(**8 9
type**9 =
:**= >
$str**? N
,**N O
nullable**P X
:**X Y
true**Z ^
)**^ _
,**_ `
ConcurrencyStamp++ $
=++% &
table++' ,
.++, -
Column++- 3
<++3 4
string++4 :
>++: ;
(++; <
type++< @
:++@ A
$str++B Q
,++Q R
nullable++S [
:++[ \
true++] a
)++a b
,++b c
PhoneNumber,, 
=,,  !
table,," '
.,,' (
Column,,( .
<,,. /
string,,/ 5
>,,5 6
(,,6 7
type,,7 ;
:,,; <
$str,,= L
,,,L M
nullable,,N V
:,,V W
true,,X \
),,\ ]
,,,] ^
TwoFactorEnabled-- $
=--% &
table--' ,
.--, -
Column--- 3
<--3 4
bool--4 8
>--8 9
(--9 :
type--: >
:--> ?
$str--@ E
,--E F
nullable--G O
:--O P
false--Q V
)--V W
,--W X

LockoutEnd.. 
=..  
table..! &
...& '
Column..' -
<..- .
DateTimeOffset... <
>..< =
(..= >
type..> B
:..B C
$str..D T
,..T U
nullable..V ^
:..^ _
true..` d
)..d e
,..e f
LockoutEnabled// "
=//# $
table//% *
.//* +
Column//+ 1
<//1 2
bool//2 6
>//6 7
(//7 8
type//8 <
://< =
$str//> C
,//C D
nullable//E M
://M N
false//O T
)//T U
,//U V
AccessFailedCount00 %
=00& '
table00( -
.00- .
Column00. 4
<004 5
int005 8
>008 9
(009 :
type00: >
:00> ?
$str00@ E
,00E F
nullable00G O
:00O P
false00Q V
)00V W
}11 
,11 
constraints22 
:22 
table22 "
=>22# %
{33 
table44 
.44 

PrimaryKey44 $
(44$ %
$str44% /
,44/ 0
x441 2
=>443 5
x446 7
.447 8
Id448 :
)44: ;
;44; <
}55 
)55 
;55 
migrationBuilder77 
.77 
CreateTable77 (
(77( )
name88 
:88 
$str88 %
,88% &
columns99 
:99 
table99 
=>99 !
new99" %
{:: 
Id;; 
=;; 
table;; 
.;; 
Column;; %
<;;% &
Guid;;& *
>;;* +
(;;+ ,
type;;, 0
:;;0 1
$str;;2 D
,;;D E
nullable;;F N
:;;N O
false;;P U
);;U V
,;;V W
TicketId<< 
=<< 
table<< $
.<<$ %
Column<<% +
<<<+ ,
Guid<<, 0
><<0 1
(<<1 2
type<<2 6
:<<6 7
$str<<8 J
,<<J K
nullable<<L T
:<<T U
false<<V [
)<<[ \
,<<\ ]
	AppUserId== 
=== 
table==  %
.==% &
Column==& ,
<==, -
Guid==- 1
>==1 2
(==2 3
type==3 7
:==7 8
$str==9 K
,==K L
nullable==M U
:==U V
false==W \
)==\ ]
,==] ^
Content>> 
=>> 
table>> #
.>># $
Column>>$ *
<>>* +
string>>+ 1
>>>1 2
(>>2 3
type>>3 7
:>>7 8
$str>>9 H
,>>H I
nullable>>J R
:>>R S
false>>T Y
)>>Y Z
,>>Z [
CreatedDate?? 
=??  !
table??" '
.??' (
Column??( .
<??. /
DateTime??/ 7
>??7 8
(??8 9
type??9 =
:??= >
$str??? J
,??J K
nullable??L T
:??T U
false??V [
)??[ \
}@@ 
,@@ 
constraintsAA 
:AA 
tableAA "
=>AA# %
{BB 
tableCC 
.CC 

PrimaryKeyCC $
(CC$ %
$strCC% 7
,CC7 8
xCC9 :
=>CC; =
xCC> ?
.CC? @
IdCC@ B
)CCB C
;CCC D
tableDD 
.DD 

ForeignKeyDD $
(DD$ %
nameEE 
:EE 
$strEE @
,EE@ A
columnFF 
:FF 
xFF  !
=>FF" $
xFF% &
.FF& '
	AppUserIdFF' 0
,FF0 1
principalTableGG &
:GG& '
$strGG( /
,GG/ 0
principalColumnHH '
:HH' (
$strHH) -
,HH- .
onDeleteII  
:II  !
ReferentialActionII" 3
.II3 4
CascadeII4 ;
)II; <
;II< =
}JJ 
)JJ 
;JJ 
migrationBuilderLL 
.LL 
CreateTableLL (
(LL( )
nameMM 
:MM 
$strMM 
,MM  
columnsNN 
:NN 
tableNN 
=>NN !
newNN" %
{OO 
IdPP 
=PP 
tablePP 
.PP 
ColumnPP %
<PP% &
GuidPP& *
>PP* +
(PP+ ,
typePP, 0
:PP0 1
$strPP2 D
,PPD E
nullablePPF N
:PPN O
falsePPP U
)PPU V
,PPV W
	AppUserIdQQ 
=QQ 
tableQQ  %
.QQ% &
ColumnQQ& ,
<QQ, -
GuidQQ- 1
>QQ1 2
(QQ2 3
typeQQ3 7
:QQ7 8
$strQQ9 K
,QQK L
nullableQQM U
:QQU V
falseQQW \
)QQ\ ]
,QQ] ^
SubjectRR 
=RR 
tableRR #
.RR# $
ColumnRR$ *
<RR* +
stringRR+ 1
>RR1 2
(RR2 3
typeRR3 7
:RR7 8
$strRR9 H
,RRH I
nullableRRJ R
:RRR S
falseRRT Y
)RRY Z
,RRZ [
CreatedDateSS 
=SS  !
tableSS" '
.SS' (
ColumnSS( .
<SS. /
DateTimeSS/ 7
>SS7 8
(SS8 9
typeSS9 =
:SS= >
$strSS? J
,SSJ K
nullableSSL T
:SST U
falseSSV [
)SS[ \
,SS\ ]
IsOpenTT 
=TT 
tableTT "
.TT" #
ColumnTT# )
<TT) *
boolTT* .
>TT. /
(TT/ 0
typeTT0 4
:TT4 5
$strTT6 ;
,TT; <
nullableTT= E
:TTE F
falseTTG L
)TTL M
}UU 
,UU 
constraintsVV 
:VV 
tableVV "
=>VV# %
{WW 
tableXX 
.XX 

PrimaryKeyXX $
(XX$ %
$strXX% 1
,XX1 2
xXX3 4
=>XX5 7
xXX8 9
.XX9 :
IdXX: <
)XX< =
;XX= >
tableYY 
.YY 

ForeignKeyYY $
(YY$ %
nameZZ 
:ZZ 
$strZZ :
,ZZ: ;
column[[ 
:[[ 
x[[  !
=>[[" $
x[[% &
.[[& '
	AppUserId[[' 0
,[[0 1
principalTable\\ &
:\\& '
$str\\( /
,\\/ 0
principalColumn]] '
:]]' (
$str]]) -
,]]- .
onDelete^^  
:^^  !
ReferentialAction^^" 3
.^^3 4
Cascade^^4 ;
)^^; <
;^^< =
}__ 
)__ 
;__ 
migrationBuilderaa 
.aa 
CreateTableaa (
(aa( )
namebb 
:bb 
$strbb #
,bb# $
columnscc 
:cc 
tablecc 
=>cc !
newcc" %
{dd 
Idee 
=ee 
tableee 
.ee 
Columnee %
<ee% &
Guidee& *
>ee* +
(ee+ ,
typeee, 0
:ee0 1
$stree2 D
,eeD E
nullableeeF N
:eeN O
falseeeP U
)eeU V
,eeV W
TicketIdff 
=ff 
tableff $
.ff$ %
Columnff% +
<ff+ ,
Guidff, 0
>ff0 1
(ff1 2
typeff2 6
:ff6 7
$strff8 J
,ffJ K
nullableffL T
:ffT U
falseffV [
)ff[ \
,ff\ ]
FileUrlgg 
=gg 
tablegg #
.gg# $
Columngg$ *
<gg* +
stringgg+ 1
>gg1 2
(gg2 3
typegg3 7
:gg7 8
$strgg9 H
,ggH I
nullableggJ R
:ggR S
falseggT Y
)ggY Z
}hh 
,hh 
constraintsii 
:ii 
tableii "
=>ii# %
{jj 
tablekk 
.kk 

PrimaryKeykk $
(kk$ %
$strkk% 5
,kk5 6
xkk7 8
=>kk9 ;
xkk< =
.kk= >
Idkk> @
)kk@ A
;kkA B
tablell 
.ll 

ForeignKeyll $
(ll$ %
namemm 
:mm 
$strmm ?
,mm? @
columnnn 
:nn 
xnn  !
=>nn" $
xnn% &
.nn& '
TicketIdnn' /
,nn/ 0
principalTableoo &
:oo& '
$stroo( 1
,oo1 2
principalColumnpp '
:pp' (
$strpp) -
,pp- .
onDeleteqq  
:qq  !
ReferentialActionqq" 3
.qq3 4
Cascadeqq4 ;
)qq; <
;qq< =
}rr 
)rr 
;rr 
migrationBuildertt 
.tt 
CreateIndextt (
(tt( )
nameuu 
:uu 
$struu 2
,uu2 3
tablevv 
:vv 
$strvv &
,vv& '
columnww 
:ww 
$strww #
)ww# $
;ww$ %
migrationBuilderyy 
.yy 
CreateIndexyy (
(yy( )
namezz 
:zz 
$strzz /
,zz/ 0
table{{ 
:{{ 
$str{{ $
,{{$ %
column|| 
:|| 
$str|| "
)||" #
;||# $
migrationBuilder~~ 
.~~ 
CreateIndex~~ (
(~~( )
name 
: 
$str ,
,, -
table
ÄÄ 
:
ÄÄ 
$str
ÄÄ  
,
ÄÄ  !
column
ÅÅ 
:
ÅÅ 
$str
ÅÅ #
)
ÅÅ# $
;
ÅÅ$ %
}
ÇÇ 	
	protected
ÖÖ 
override
ÖÖ 
void
ÖÖ 
Down
ÖÖ  $
(
ÖÖ$ %
MigrationBuilder
ÖÖ% 5
migrationBuilder
ÖÖ6 F
)
ÖÖF G
{
ÜÜ 	
migrationBuilder
áá 
.
áá 
	DropTable
áá &
(
áá& '
name
àà 
:
àà 
$str
àà 
)
àà 
;
àà 
migrationBuilder
ää 
.
ää 
	DropTable
ää &
(
ää& '
name
ãã 
:
ãã 
$str
ãã %
)
ãã% &
;
ãã& '
migrationBuilder
çç 
.
çç 
	DropTable
çç &
(
çç& '
name
éé 
:
éé 
$str
éé #
)
éé# $
;
éé$ %
migrationBuilder
êê 
.
êê 
	DropTable
êê &
(
êê& '
name
ëë 
:
ëë 
$str
ëë 
)
ëë  
;
ëë  !
migrationBuilder
ìì 
.
ìì 
	DropTable
ìì &
(
ìì& '
name
îî 
:
îî 
$str
îî 
)
îî 
;
îî 
}
ïï 	
}
ññ 
}óó ⁄
GC:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Migrations\20231213193806_mg2.cs
	namespace 	
ITDeskServer
 
. 

Migrations !
{ 
public 

partial 
class 
mg2 
: 
	Migration (
{		 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
} 	
} 
} ª
GC:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Migrations\20231213200957_mg3.cs
	namespace 	
ITDeskServer
 
. 

Migrations !
{ 
public		 

partial		 
class		 
mg3		 
:		 
	Migration		 (
{

 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str $
,$ %
columns 
: 
table 
=> !
new" %
{ 
RoleId 
= 
table "
." #
Column# )
<) *
Guid* .
>. /
(/ 0
type0 4
:4 5
$str6 H
,H I
nullableJ R
:R S
falseT Y
)Y Z
,Z [
UserId 
= 
table "
." #
Column# )
<) *
Guid* .
>. /
(/ 0
type0 4
:4 5
$str6 H
,H I
nullableJ R
:R S
falseT Y
)Y Z
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% 6
,6 7
x8 9
=>: <
new= @
{A B
xC D
.D E
RoleIdE K
,K L
xM N
.N O
UserIdO U
}V W
)W X
;X Y
} 
) 
; 
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 
	DropTable &
(& '
name 
: 
$str $
)$ %
;% &
}   	
}!! 
}"" Ö
GC:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Migrations\20231213201108_mg4.cs
	namespace 	
ITDeskServer
 
. 

Migrations !
{ 
public 

partial 
class 
mg4 
: 
	Migration (
{		 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
AddForeignKey *
(* +
name 
: 
$str 4
,4 5
table 
: 
$str %
,% &
column 
: 
$str  
,  !
principalTable 
: 
$str  '
,' (
principalColumn 
:  
$str! %
,% &
onDelete 
: 
ReferentialAction +
.+ ,
Cascade, 3
)3 4
;4 5
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 
DropForeignKey +
(+ ,
name 
: 
$str 4
,4 5
table 
: 
$str %
)% &
;& '
} 	
} 
} ‹
8C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Models\AppRole.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 
AppRole 
: 
IdentityRole *
<* +
Guid+ /
>/ 0
{ 
} ¨
8C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Models\AppUser.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 
AppUser 
: 
IdentityUser *
<* +
Guid+ /
>/ 0
{ 
public		 

string		 
	FirstName		 
{		 
get		 !
;		! "
set		# &
;		& '
}		( )
=		* +
string		, 2
.		2 3
Empty		3 8
;		8 9
public

 

string

 
LastName

 
{

 
get

  
;

  !
set

" %
;

% &
}

' (
=

) *
string

+ 1
.

1 2
Empty

2 7
;

7 8
public 

string 
? 
GoogleProvideId "
{# $
get% (
;( )
set* -
;- .
}/ 0
[ 
	NotMapped 
] 
public 

override 
bool  
PhoneNumberConfirmed -
{. /
get0 3
;3 4
set5 8
;8 9
}: ;
public 

string 
GetName 
( 
) 
{ 
return 
string 
. 
Join 
( 
$str 
, 
	FirstName  )
,) *
LastName+ 3
)3 4
;4 5
} 
} „
<C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Models\AppUserRole.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 
AppUserRole 
{ 
public 

Guid 
RoleId 
{ 
get 
; 
set !
;! "
}# $
public 

AppRole 
? 
Role 
{ 
get 
; 
set  #
;# $
}% &
public		 

Guid		 
UserId		 
{		 
get		 
;		 
set		 !
;		! "
}		# $
}

 ‚
7C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Models\Ticket.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 
Ticket 
{ 
public 

Guid 
Id 
{ 
get 
; 
set 
; 
}  
public 

Guid 
	AppUserId 
{ 
get 
;  
set! $
;$ %
}& '
public 

AppUser 
? 
AppUser 
{ 
get !
;! "
set# &
;& '
}( )
public 

string 
Subject 
{ 
get 
;  
set! $
;$ %
}& '
=( )
string* 0
.0 1
Empty1 6
;6 7
public		 

DateTime		 
CreatedDate		 
{		  !
get		" %
;		% &
set		' *
;		* +
}		, -
public

 

bool

 
IsOpen

 
{

 
get

 
;

 
set

 !
;

! "
}

# $
public 

List 
< 

TicketFile 
> 
? 
FileUrls %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
} ˝
=C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Models\TicketDetail.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 
TicketDetail  
{ 
public 

TicketDetail 
( 
) 
{ 
Id 

= 
Guid 
. 
NewGuid 
( 
) 
; 
} 
public		 

Guid		 
Id		 
{		 
get		 
;		 
set		 
;		 
}		  
public

 

Guid

 
TicketId

 
{

 
get

 
;

 
set

  #
;

# $
}

% &
public 

Guid 
	AppUserId 
{ 
get 
;  
set! $
;$ %
}& '
public 

AppUser 
? 
AppUser 
{ 
get !
;! "
set# &
;& '
}( )
public 

string 
Content 
{ 
get 
;  
set! $
;$ %
}& '
=( )
string* 0
.0 1
Empty1 6
;6 7
public 

DateTime 
CreatedDate 
{  !
get" %
;% &
set' *
;* +
}, -
} ¶
;C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Models\TicketFile.cs
	namespace 	
ITDeskServer
 
. 
Models 
; 
public 
sealed 
class 

TicketFile 
{ 
public 

Guid 
Id 
{ 
get 
; 
set 
; 
}  
public 

Guid 
TicketId 
{ 
get 
; 
set  #
;# $
}% &
public 

string 
FileUrl 
{ 
get 
;  
set! $
;$ %
}& '
=( )
string* 0
.0 1
Empty1 6
;6 7
} Ä?
1C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder 
. 
Services 
. 
AddCors 
( 
	configure "
=># %
{ 
	configure 
. 
AddDefaultPolicy 
( 
policy %
=>& (
{ 
policy 
. 
AllowAnyHeader 
( 
) 
. 
AllowAnyOrigin 
( 
) 
. 
AllowAnyMethod 
( 
) 
; 
} 
) 
; 
} 
) 
; 
builder 
. 
Services 
. 
TryAddScoped 
< 

JwtService (
>( )
() *
)* +
;+ ,
builder   
.   
Services   
.   
AddAuthentication   "
(  " #
)  # $
.  $ %
AddJwtBearer  % 1
(  1 2
options  2 9
=>  : <
{!! 
options"" 
."" %
TokenValidationParameters"" %
=""& '
new""( +
(""+ ,
)"", -
{## 
ValidateIssuer$$ 
=$$ 
true$$ 
,$$ 
ValidateAudience%% 
=%% 
true%% 
,%%  $
ValidateIssuerSigningKey&&  
=&&! "
true&&# '
,&&' (
ValidateLifetime'' 
='' 
true'' 
,''  
ValidIssuer(( 
=(( 
$str(( $
,(($ %
ValidAudience)) 
=)) 
$str)) -
,))- .
IssuerSigningKey** 
=** 
new**  
SymmetricSecurityKey** 3
(**3 4
Encoding**4 <
.**< =
UTF8**= A
.**A B
GetBytes**B J
(**J K
$str	**K ≤
)
**≤ ≥
)
**≥ ¥
}++ 
;++ 
},, 
),, 
;,, 
builder00 
.00 
Services00 
.00 
AddDbContext00 
<00  
ApplicationDbContext00 2
>002 3
(003 4
options004 ;
=>00< >
{11 
options22 
.22 
UseSqlServer22 
(22 
$str	22 Ë
)
22Ë È
;
22È Í
}33 
)33 
;33 
builder44 
.44 
Services44 
.44 
AddIdentity44 
<44 
AppUser44 $
,44$ %
AppRole44& -
>44- .
(44. /
opt44/ 2
=>443 5
{55 
opt66 
.66 
Password66 
.66 
RequiredLength66 
=66  !
$num66" #
;66# $
opt77 
.77 
SignIn77 
.77 !
RequireConfirmedEmail77 $
=77% &
true77' +
;77+ ,
opt88 
.88 
Lockout88 
.88 "
DefaultLockoutTimeSpan88 &
=88' (
TimeSpan88) 1
.881 2
FromMinutes882 =
(88= >
$num88> ?
)88? @
;88@ A
opt99 
.99 
Lockout99 
.99 #
MaxFailedAccessAttempts99 '
=99( )
$num99* +
;99+ ,
opt:: 
.:: 
Lockout:: 
.:: 
AllowedForNewUsers:: "
=::# $
true::% )
;::) *
}<< 
)<< 
.== $
AddEntityFrameworkStores== 
<==  
ApplicationDbContext== 2
>==2 3
(==3 4
)==4 5
.>> $
AddDefaultTokenProviders>> 
(>> 
)>> 
;>>  
builderBB 
.BB 
ServicesBB 
.BB 
AddControllersBB 
(BB  
)BB  !
.BB! "
AddODataBB" *
(BB* +
optionsBB+ 2
=>BB2 4
optionsBB5 <
.BB< =
EnableQueryFeaturesBB= P
(BBP Q
)BBQ R
)BBR S
;BBS T
builderCC 
.CC 
ServicesCC 
.CC #
AddEndpointsApiExplorerCC (
(CC( )
)CC) *
;CC* +
builderDD 
.DD 
ServicesDD 
.DD 
AddSwaggerGenDD 
(DD 
setupDD $
=>DD% '
{EE 
varFF 
jwtSecurityShemeFF 
=FF 
newFF !
OpenApiSecuritySchemeFF 4
{GG 
BearerFormatHH 
=HH 
$strHH 
,HH 
NameII 
=II 
$strII #
,II# $
InJJ 

=JJ 
ParameterLocationJJ 
.JJ 
HeaderJJ %
,JJ% &
TypeKK 
=KK 
SecuritySchemeTypeKK !
.KK! "
HttpKK" &
,KK& '
SchemeLL 
=LL 
JwtBearerDefaultsLL "
.LL" # 
AuthenticationSchemeLL# 7
,LL7 8
DescriptionMM 
=MM 
$strMM O
,MMO P
	ReferenceOO 
=OO 
newOO 
OpenApiReferenceOO (
{PP 	
IdQQ 
=QQ 
JwtBearerDefaultsQQ "
.QQ" # 
AuthenticationSchemeQQ# 7
,QQ7 8
TypeRR 
=RR 
ReferenceTypeRR  
.RR  !
SecuritySchemeRR! /
}SS 	
}TT 
;TT 
setupVV 	
.VV	 
!
AddSecurityDefinitionVV
 
(VV  
jwtSecurityShemeVV  0
.VV0 1
	ReferenceVV1 :
.VV: ;
IdVV; =
,VV= >
jwtSecurityShemeVV? O
)VVO P
;VVP Q
setupXX 	
.XX	 
"
AddSecurityRequirementXX
  
(XX  !
newXX! $&
OpenApiSecurityRequirementXX% ?
{YY 
{ZZ 
jwtSecurityShemeZZ &
,ZZ& '
ArrayZZ( -
.ZZ- .
EmptyZZ. 3
<ZZ3 4
stringZZ4 :
>ZZ: ;
(ZZ; <
)ZZ< =
}ZZ> ?
}[[ 
)[[ 
;[[ 
}\\ 
)\\ 
;\\ 
varaa 
appaa 
=aa 	
builderaa
 
.aa 
Buildaa 
(aa 
)aa 
;aa 
ifcc 
(cc 
appcc 
.cc 
Environmentcc 
.cc 
IsDevelopmentcc !
(cc! "
)cc" #
)cc# $
{dd 
appee 
.ee 

UseSwaggeree 
(ee 
)ee 
;ee 
appff 
.ff 
UseSwaggerUIff 
(ff 
)ff 
;ff 
}gg 
appii 
.ii 
UseCorsii 
(ii 
)ii 
;ii 
appkk 
.kk 
UseHttpsRedirectionkk 
(kk 
)kk 
;kk 
appmm 
.mm 
UseAuthorizationmm 
(mm 
)mm 
;mm 
appoo 
.oo 
MapControllersoo 
(oo 
)oo 
;oo 
ExtensionsMiddlewareqq 
.qq 
AutoMigrationqq "
(qq" #
appqq# &
)qq& '
;qq' (
ExtensionsMiddlewarerr 
.rr 
CreateFirstUserrr $
(rr$ %
apprr% (
)rr( )
;rr) *
ExtensionsMiddlewaress 
.ss 
CreateRolesss  
(ss  !
appss! $
)ss$ %
;ss% &
ExtensionsMiddlewarett 
.tt 
CreateUserRolett #
(tt# $
apptt$ '
)tt' (
;tt( )
appvv 
.vv 
Runvv 
(vv 
)vv 	
;vv	 
ñ!
=C:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Services\JwtService.cs
	namespace 	
ITDeskServer
 
. 
Services 
;  
public		 
sealed		 
class		 

JwtService		 
{

 
public 

string 
CreateToken 
( 
AppUser %
appUser& -
,- .
List/ 3
<3 4
string4 :
?: ;
>; <
?< =
roles> C
,C D
boolE I

rememberMeJ T
)T U
{ 
string 
token 
= 
string 
. 
Empty #
;# $
List 
< 
Claim 
> 
claims 
= 
new  
(  !
)! "
;" #
claims 
. 
Add 
( 
new 
( 
$str 
,  
appUser! (
.( )
Id) +
.+ ,
ToString, 4
(4 5
)5 6
)6 7
)7 8
;8 9
claims 
. 
Add 
( 
new 
( 
$str 
, 
appUser &
.& '
GetName' .
(. /
)/ 0
)0 1
)1 2
;2 3
claims 
. 
Add 
( 
new 
( 
$str 
, 
appUser  '
.' (
Email( -
??. 0
string1 7
.7 8
Empty8 =
)= >
)> ?
;? @
claims 
. 
Add 
( 
new 
( 
$str !
,! "
appUser# *
.* +
UserName+ 3
??4 6
string7 =
.= >
Empty> C
)C D
)D E
;E F
if 

(
 
roles 
is 
not 
null 
) 
claims $
.$ %
Add% (
(( )
new) ,
(, -
$str- 4
,4 5
string6 <
.< =
Join= A
(A B
$strB E
,E F
rolesG L
)L M
)M N
)N O
;O P
DateTime 
expires 
= 

rememberMe %
?& '
DateTime( 0
.0 1
Now1 4
.4 5
	AddMonths5 >
(> ?
$num? @
)@ A
:B C
DateTimeD L
.L M
NowM P
.P Q
AddDaysQ X
(X Y
$numY Z
)Z [
;[ \
JwtSecurityToken 
jwtSecurityToken )
=* +
new, /
(/ 0
issuer 
: 
$str "
," #
audience 
: 
$str +
,+ ,
claims 
: 
claims 
, 
	notBefore 
: 
DateTime 
.  
Now  #
,# $
expires 
: 
expires 
, 
signingCredentials 
: 
new  #
SigningCredentials$ 6
(6 7
new7 : 
SymmetricSecurityKey; O
(O P
EncodingP X
.X Y
UTF8Y ]
.] ^
GetBytes^ f
(f g
$str	g Œ
)
Œ œ
)
œ –
,
– — 
SecurityAlgorithms
“ ‰
.
‰ Â

HmacSha512
Â Ô
)
Ô 
)
 Ò
;
Ò Ú#
JwtSecurityTokenHandler   
handler    '
=  ( )
new  * -
(  - .
)  . /
;  / 0
token!! 
=!! 
handler!! 
.!! 

WriteToken!! "
(!!" #
jwtSecurityToken!!# 3
)!!3 4
;!!4 5
return## 
token## 
;## 
}$$ 
}%% ü
CC:\YMYP1\06.WebApi\ITDesk\ITDeskServer\Validators\LoginValidator.cs
	namespace 	
ITDeskServer
 
. 
	Validator  
;  !
public 
sealed 
class 
LoginValidator "
:# $
AbstractValidator% 6
<6 7
LoginDto7 ?
>? @
{ 
public 

LoginValidator 
( 
) 
{		 
RuleFor

 
(

 
p

 
=>

 
p

 
.

 
UserNameOrEmail

 &
)

& '
.

' (
NotEmpty

( 0
(

0 1
)

1 2
.

2 3
WithMessage

3 >
(

> ?
$str

? r
)

r s
;

s t
RuleFor 
( 
p 
=> 
p 
. 
UserNameOrEmail &
)& '
.' (
MinimumLength( 5
(5 6
$num6 7
)7 8
.8 9
WithMessage9 D
(D E
$strE x
)x y
;y z
RuleFor 
( 
p 
=> 
p 
. 
Password 
)  
.  !
NotEmpty! )
() *
)* +
.+ ,
WithMessage, 7
(7 8
$str8 P
)P Q
;Q R
RuleFor 
( 
p 
=> 
p 
. 
Password 
)  
.  !
Matches! (
(( )
$str) 0
)0 1
.1 2
WithMessage2 =
(= >
$str> i
)i j
;j k
RuleFor 
( 
p 
=> 
p 
. 
Password 
)  
.  !
Matches! (
(( )
$str) 0
)0 1
.1 2
WithMessage2 =
(= >
$str> i
)i j
;j k
RuleFor 
( 
p 
=> 
p 
. 
Password 
)  
.  !
Matches! (
(( )
$str) 0
)0 1
.1 2
WithMessage2 =
(= >
$str> d
)d e
;e f
RuleFor 
( 
p 
=> 
p 
. 
Password 
)  
.  !
Matches! (
(( )
$str) 7
)7 8
.8 9
WithMessage9 D
(D E
$strE s
)s t
;t u
} 
} 